<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>notify dashboard</title>
<style>
:root {
  --bg: #1a1b26;
  --bg2: #24283b;
  --bg3: #292e42;
  --fg: #c0caf5;
  --fg-dim: #565f89;
  --accent: #7aa2f7;
  --green: #9ece6a;
  --yellow: #e0af68;
  --red: #f7768e;
  --cyan: #7dcfff;
  --border: #3b4261;
  --font: "Cascadia Code", "Fira Code", "JetBrains Mono", "Consolas", monospace;
}

[data-theme="light"] {
  --bg: #f5f5f5;
  --bg2: #ffffff;
  --bg3: #e8e8ec;
  --fg: #1a1b26;
  --fg-dim: #6b7280;
  --accent: #2563eb;
  --green: #16a34a;
  --yellow: #ca8a04;
  --red: #dc2626;
  --cyan: #0891b2;
  --border: #d1d5db;
}

[data-theme="light"] .badge-exec { background: rgba(22, 163, 74, 0.12); }
[data-theme="light"] .badge-skip { background: rgba(202, 138, 4, 0.12); }
[data-theme="light"] .cred-ok { background: rgba(22, 163, 74, 0.12); }
[data-theme="light"] .cred-missing { background: rgba(220, 38, 38, 0.12); }
[data-theme="light"] .new-entry { animation: fadeInLight 0.3s ease-in; }

@keyframes fadeInLight {
  from { background: rgba(37, 99, 235, 0.1); }
  to { background: transparent; }
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--fg);
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.5;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

header h1 {
  font-size: 18px;
  font-weight: 600;
  color: var(--accent);
}

header .status {
  font-size: 12px;
  color: var(--fg-dim);
}

header .status .dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  margin-right: 6px;
  vertical-align: middle;
}

.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 0;
}

.tab {
  padding: 8px 20px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 6px 6px 0 0;
  color: var(--fg-dim);
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  transition: all 0.15s;
}

.tab:hover { color: var(--fg); background: var(--bg3); }
.tab.active { color: var(--accent); background: var(--bg3); border-color: var(--accent); }

.panel {
  display: none;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 0 8px 8px 8px;
  padding: 16px;
  min-height: 400px;
}

.panel.active { display: block; }

/* History table */
table {
  width: 100%;
  border-collapse: collapse;
}

th {
  text-align: left;
  padding: 8px 12px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--fg-dim);
  border-bottom: 1px solid var(--border);
}

td {
  padding: 6px 12px;
  border-bottom: 1px solid var(--bg3);
  font-size: 13px;
}

tr:hover td { background: var(--bg3); }

.kind-execution { color: var(--green); }
.kind-cooldown { color: var(--yellow); }
.kind-silent { color: var(--fg-dim); }
.kind-other { color: var(--fg-dim); }

.new-entry { animation: fadeIn 0.3s ease-in; }

@keyframes fadeIn {
  from { background: rgba(122, 162, 247, 0.15); }
  to { background: transparent; }
}

/* Config panel */
.config-json {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px;
  overflow-x: auto;
  white-space: pre;
  font-size: 13px;
  line-height: 1.6;
  color: var(--fg);
  max-height: 600px;
  overflow-y: auto;
}

/* Test panel */
.test-form {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.test-form label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 12px;
  color: var(--fg-dim);
}

.test-form select, .test-form button {
  padding: 8px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  min-width: 160px;
}

.test-form select:focus, .test-form button:focus {
  outline: none;
  border-color: var(--accent);
}

.test-form button {
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
  cursor: pointer;
  min-width: auto;
  padding: 8px 24px;
  transition: opacity 0.15s;
}

.test-form button:hover { opacity: 0.85; }

.test-results {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px;
  min-height: 100px;
}

.test-results .action-name,
.modal .action-name {
  font-weight: 600;
  color: var(--cyan);
  margin-bottom: 8px;
  font-size: 14px;
}

.test-results .step,
.modal .step {
  display: flex;
  gap: 12px;
  padding: 4px 0;
  font-size: 13px;
}

.step .marker { font-weight: 600; width: 42px; text-align: center; }
.step .marker.run { color: var(--green); }
.step .marker.skip { color: var(--fg-dim); }
.step .idx { color: var(--fg-dim); width: 30px; }
.step .type { color: var(--yellow); width: 100px; }
.step .detail { color: var(--fg); flex: 1; }

.summary-section { margin-top: 16px; }
.summary-section h3 {
  font-size: 13px;
  color: var(--fg-dim);
  margin-bottom: 8px;
}

.days-control {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
  font-size: 12px;
  color: var(--fg-dim);
}

.days-control select {
  padding: 4px 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 12px;
}

.export-btn {
  padding: 4px 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 12px;
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
}

.export-btn:hover { border-color: var(--accent); color: var(--accent); }

.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  color: var(--fg-dim);
  font-size: 14px;
}

.badge {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.badge-exec { background: rgba(158, 206, 106, 0.15); color: var(--green); }
.badge-skip { background: rgba(224, 175, 104, 0.15); color: var(--yellow); }

/* Activity chart */
.activity-chart {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px 16px 8px;
  position: relative;
}

.activity-chart svg { display: block; }
.chart-bar { transition: opacity 0.15s; cursor: crosshair; }
.chart-bar:hover { opacity: 0.8; }

.chart-tooltip {
  display: none;
  position: absolute;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 6px 10px;
  font-size: 12px;
  color: var(--fg);
  pointer-events: none;
  white-space: nowrap;
  z-index: 10;
}

/* Watch panel */
.watch-date {
  color: var(--fg-dim);
  font-size: 14px;
  margin-bottom: 12px;
}

.watch-table {
  width: auto;
  min-width: 500px;
  margin-bottom: 24px;
}

.watch-table th {
  text-align: right;
  padding: 6px 12px;
  font-size: 12px;
  text-transform: none;
  letter-spacing: 0;
}

.watch-table th:first-child { text-align: left; }

.watch-table td {
  text-align: right;
  padding: 4px 12px;
  font-size: 13px;
}

.watch-table td:first-child { text-align: left; }

.watch-table .profile-row td { font-weight: 600; }
.watch-table .profile-name { color: var(--cyan); }
.watch-table .action-name { color: var(--fg); padding-left: 28px !important; font-weight: 400; }
.watch-table .total-row td { font-weight: 700; border-top: 1px solid var(--border); }
.watch-table .val-skip { color: var(--yellow); }
.watch-table .val-new { color: var(--green); }
.watch-table .val-zero { color: var(--fg-dim); }
.watch-table .val-dash { color: var(--fg-dim); }

.watch-section-title {
  font-size: 12px;
  color: var(--fg-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.watch-nav {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.watch-nav button {
  padding: 4px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}

.watch-nav button:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
.watch-nav button:disabled { opacity: 0.3; cursor: default; }

.watch-nav .watch-nav-date {
  font-size: 14px;
  color: var(--fg);
  min-width: 200px;
  text-align: center;
}

.watch-nav .watch-nav-today {
  color: var(--accent);
  background: transparent;
  border-color: var(--accent);
  font-weight: 600;
}

/* Credential health panel */
.cred-panel {
  margin-bottom: 16px;
  padding: 12px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
}

.cred-panel h3 {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--fg-dim);
  margin-bottom: 8px;
}

.cred-profile {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 4px 0;
  font-size: 13px;
}

.cred-profile-name {
  color: var(--cyan);
  font-weight: 600;
  min-width: 120px;
}

.cred-badge {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.cred-ok { background: rgba(158, 206, 106, 0.15); color: var(--green); }
.cred-missing { background: rgba(247, 118, 142, 0.15); color: var(--red); }

/* History filter bar */
.filter-bar {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
  font-size: 12px;
  color: var(--fg-dim);
}

.filter-bar label {
  display: flex;
  align-items: center;
  gap: 6px;
}

.filter-bar select {
  padding: 4px 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 12px;
}

.shortcuts-hint {
  font-size: 11px;
  color: var(--fg-dim);
  margin-left: auto;
  opacity: 0.6;
}

/* Toast notifications */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column-reverse;
  gap: 8px;
  z-index: 1000;
  pointer-events: none;
}

.toast {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 13px;
  min-width: 240px;
  max-width: 360px;
  animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in forwards;
  animation-delay: 0s, 4s;
  pointer-events: auto;
}

.toast-cooldown { border-left-color: var(--yellow); }
.toast-silent { border-left-color: var(--fg-dim); }

.toast-profile { color: var(--cyan); font-weight: 600; }
.toast-action { color: var(--fg); }
.toast-kind { font-size: 11px; margin-top: 2px; }

@keyframes toastIn {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes toastOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

.theme-toggle {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--fg-dim);
  cursor: pointer;
  font-size: 16px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s, border-color 0.15s;
}

.theme-toggle:hover { color: var(--accent); border-color: var(--accent); }

.screenshot-badge {
  font-size: 11px;
  color: var(--yellow);
  border: 1px solid var(--yellow);
  border-radius: 4px;
  padding: 1px 8px;
  opacity: 0.7;
}

/* Profile detail modal */
.modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.55);
  z-index: 900;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  max-width: 700px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  padding: 20px;
  z-index: 901;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.modal-header h2 { font-size: 16px; color: var(--cyan); font-weight: 600; }

.modal-close {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--fg-dim);
  cursor: pointer;
  font-size: 18px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s, border-color 0.15s;
}

.modal-close:hover { color: var(--accent); border-color: var(--accent); }

.profile-link { cursor: pointer; color: var(--cyan); }
.profile-link:hover { text-decoration: underline; }

.modal-section-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--fg-dim);
  margin: 16px 0 8px;
}

.modal-section-title:first-child { margin-top: 0; }

.modal-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100px;
  color: var(--fg-dim);
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>notify dashboard</h1>
    <span id="screenshot-badge" class="screenshot-badge" style="display:none">screenshot</span>
    <button class="theme-toggle" id="theme-toggle" title="Toggle theme"></button>
    <div class="status"><span class="dot" id="sse-dot"></span><span id="sse-status">connecting...</span></div>
  </header>
  <div style="font-size:12px;color:var(--fg-dim);margin:-12px 0 16px;display:flex;justify-content:space-between">
    <span>Cross-platform notification engine for the command line. <a href="https://github.com/Mavwarf/notify" target="_blank" rel="noopener" style="color:var(--cyan)">github.com/Mavwarf/notify</a></span>
    <span class="shortcuts-hint">Keys: 1-5 tabs, arrows nav days, t today, s screenshot</span>
  </div>

  <div class="tabs">
    <button class="tab active" data-panel="watch">Watch</button>
    <button class="tab" data-panel="history">History</button>
    <button class="tab" data-panel="config">Config</button>
    <button class="tab" data-panel="test">Test</button>
    <button class="tab" data-panel="voice">Voice</button>
  </div>

  <div class="panel" id="panel-history">
    <div class="filter-bar">
      <label>Profile <select id="filter-profile"><option value="">(all)</option></select></label>
      <label>Kind <select id="filter-kind"><option value="">(all)</option><option value="execution">execution</option><option value="cooldown">cooldown</option><option value="silent">silent</option></select></label>
    </div>
    <div class="days-control">
      <span>Show last</span>
      <select id="history-days">
        <option value="1h" selected>1 hour</option>
        <option value="4h">4 hours</option>
        <option value="12h">12 hours</option>
        <option value="1">1 day</option>
        <option value="3">3 days</option>
        <option value="7">7 days</option>
        <option value="14">14 days</option>
        <option value="30">30 days</option>
        <option value="0">ever</option>
      </select>
      <span style="margin-left:12px">Export log to:</span>
      <button class="export-btn" id="export-csv" title="Download as CSV">CSV</button>
      <button class="export-btn" id="export-json" title="Download as JSON">JSON</button>
    </div>
    <div class="summary-section">
      <h3>Summary</h3>
      <div id="summary-content"></div>
    </div>
    <div class="summary-section" id="chart-section" style="display:none">
      <h3>Activity</h3>
      <div class="activity-chart" id="chart-content">
        <div class="chart-tooltip" id="chart-tooltip"></div>
      </div>
    </div>
    <div class="summary-section">
      <h3>Logs</h3>
    </div>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Profile</th>
          <th>Action</th>
          <th>Kind</th>
        </tr>
      </thead>
      <tbody id="history-body"></tbody>
    </table>
    <div class="empty-state" id="history-empty" style="display:none">
      No log entries found. Enable logging with --log or "log": true in config.
    </div>
  </div>

  <div class="panel active" id="panel-watch">
    <div class="watch-nav">
      <button id="watch-prev" title="Previous day">&lt;</button>
      <span class="watch-nav-date" id="watch-nav-date"></span>
      <button id="watch-next" title="Next day">&gt;</button>
      <button id="watch-today" class="watch-nav-today">Today</button>
    </div>
    <div id="watch-content">
      <div class="empty-state">Loading watch data...</div>
    </div>
  </div>

  <div class="panel" id="panel-config">
    <div class="cred-panel" id="cred-panel" style="display:none">
      <h3>Credential Health</h3>
      <div id="cred-content"></div>
    </div>
    <pre class="config-json" id="config-content">Loading...</pre>
  </div>

  <div class="panel" id="panel-test">
    <div class="test-form">
      <label>
        Profile
        <select id="test-profile"></select>
      </label>
      <label>
        Action
        <select id="test-action">
          <option value="">(all actions)</option>
        </select>
      </label>
      <button id="test-btn">Dry Run</button>
    </div>
    <div class="test-results" id="test-results">
      <div class="empty-state">Select a profile and click Dry Run to preview step execution.</div>
    </div>
  </div>

  <div class="panel" id="panel-voice">
    <div class="days-control">
      <span>Time range</span>
      <select id="voice-days">
        <option value="0" selected>All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
    </div>
    <div id="voice-content">
      <div class="empty-state">Loading...</div>
    </div>
  </div>
</div>
<div class="toast-container" id="toast-container"></div>
<div class="modal-backdrop" id="modal-backdrop" style="display:none">
  <div class="modal" id="modal">
    <div class="modal-header">
      <h2 id="modal-title"></h2>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
(function() {
  // ---- Theme toggle ----
  var themeToggle = document.getElementById('theme-toggle');
  var savedTheme = localStorage.getItem('notify-theme');
  if (savedTheme === 'light') {
    document.documentElement.dataset.theme = 'light';
  } else {
    document.documentElement.dataset.theme = 'dark';
  }

  function updateToggleIcon() {
    themeToggle.textContent = document.documentElement.dataset.theme === 'dark' ? '\u2600' : '\u263D';
    themeToggle.title = document.documentElement.dataset.theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
  }
  updateToggleIcon();

  themeToggle.addEventListener('click', function() {
    var next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = next;
    localStorage.setItem('notify-theme', next);
    updateToggleIcon();
  });

  // ---- Screenshot mode ----
  var screenshotMode = localStorage.getItem('notify-screenshot') === 'on';
  var screenshotMap = (function() {
    try { return JSON.parse(localStorage.getItem('notify-screenshot-map')) || {}; }
    catch(e) { return {}; }
  })();
  var profilePool = ['project-alpha','project-beta','project-gamma','project-delta','project-epsilon','project-zeta','project-eta','project-theta'];
  var profilePoolIdx = Object.keys(screenshotMap).length;

  function maskProfile(name) {
    if (!screenshotMode) return name;
    if (screenshotMap[name]) return screenshotMap[name];
    var fake = profilePoolIdx < profilePool.length ? profilePool[profilePoolIdx] : 'profile-' + (profilePoolIdx + 1);
    profilePoolIdx++;
    screenshotMap[name] = fake;
    localStorage.setItem('notify-screenshot-map', JSON.stringify(screenshotMap));
    return fake;
  }

  function updateScreenshotBadge() {
    document.getElementById('screenshot-badge').style.display = screenshotMode ? '' : 'none';
  }
  updateScreenshotBadge();

  // ---- Tab switching ----
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');

  function switchTab(name) {
    tabs.forEach(t => t.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    const tab = document.querySelector('.tab[data-panel="' + name + '"]');
    if (tab) {
      tab.classList.add('active');
      document.getElementById('panel-' + name).classList.add('active');
      history.replaceState(null, '', '#' + name);
    }
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.panel));
  });

  // Open tab from URL hash (e.g. /#watch).
  const hash = location.hash.replace('#', '');
  if (hash && document.getElementById('panel-' + hash)) {
    switchTab(hash);
  }

  // ---- Helper ----
  function formatTime(iso) {
    const d = new Date(iso);
    return d.toLocaleString(undefined, {
      month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  }

  function kindClass(kind) {
    return 'kind-' + kind;
  }

  // ---- History ----
  const historyBody = document.getElementById('history-body');
  const historyEmpty = document.getElementById('history-empty');
  const historyDays = document.getElementById('history-days');
  const filterProfile = document.getElementById('filter-profile');
  const filterKind = document.getElementById('filter-kind');
  let allHistoryEntries = [];

  function matchesFilter(entry) {
    const fp = filterProfile.value;
    const fk = filterKind.value;
    if (fp && entry.profile !== fp) return false;
    if (fk && entry.kind !== fk) return false;
    return true;
  }

  function populateFilterProfiles(entries) {
    const profiles = new Set();
    for (const e of entries) profiles.add(e.profile);
    const current = filterProfile.value;
    filterProfile.innerHTML = '<option value="">(all)</option>';
    for (const p of [...profiles].sort()) {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = maskProfile(p);
      if (p === current) opt.selected = true;
      filterProfile.appendChild(opt);
    }
  }

  function renderHistory(entries) {
    allHistoryEntries = entries || [];
    populateFilterProfiles(allHistoryEntries);
    historyBody.innerHTML = '';
    const filtered = allHistoryEntries.filter(matchesFilter);
    if (filtered.length === 0) {
      historyEmpty.style.display = '';
      return;
    }
    historyEmpty.style.display = 'none';
    // Show newest first
    for (let i = filtered.length - 1; i >= 0; i--) {
      appendHistoryRow(filtered[i], false);
    }
  }

  function appendHistoryRow(entry, isNew) {
    if (isNew && !matchesFilter(entry)) return;
    const tr = document.createElement('tr');
    if (isNew) tr.classList.add('new-entry');
    tr.innerHTML =
      '<td>' + formatTime(entry.time) + '</td>' +
      '<td><span class="profile-link" onclick="window._openProfileModal(\'' + esc(entry.profile).replace(/'/g, "\\'") + '\')">' + esc(maskProfile(entry.profile)) + '</span></td>' +
      '<td>' + esc(entry.action) + '</td>' +
      '<td class="' + kindClass(entry.kind) + '">' + esc(entry.kind) + '</td>';
    // Insert at top (newest first)
    if (historyBody.firstChild) {
      historyBody.insertBefore(tr, historyBody.firstChild);
    } else {
      historyBody.appendChild(tr);
    }
    historyEmpty.style.display = 'none';
  }

  filterProfile.addEventListener('change', () => renderHistory(allHistoryEntries));
  filterKind.addEventListener('change', () => renderHistory(allHistoryEntries));

  function esc(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function historyQueryParam() {
    const val = historyDays.value;
    if (val.endsWith('h')) return 'hours=' + val.slice(0, -1);
    return 'days=' + val;
  }

  async function loadHistory() {
    try {
      const res = await fetch('/api/history?' + historyQueryParam());
      const data = await res.json();
      renderHistory(data);
    } catch(e) {
      console.error('Failed to load history:', e);
    }
  }

  historyDays.addEventListener('change', () => {
    loadHistory();
    loadSummary();
  });

  // ---- Export ----
  function exportHistory(format) {
    const filtered = allHistoryEntries.filter(matchesFilter);
    // Newest first, matching table display order
    const sorted = filtered.slice().reverse();

    var content, mime, ext;
    if (format === 'json') {
      content = JSON.stringify(sorted.map(function(e) {
        return { time: e.time, profile: e.profile, action: e.action, kind: e.kind };
      }), null, 2);
      mime = 'application/json';
      ext = 'json';
    } else {
      var lines = ['Time,Profile,Action,Kind'];
      for (var i = 0; i < sorted.length; i++) {
        var e = sorted[i];
        lines.push(csvField(e.time) + ',' + csvField(e.profile) + ',' + csvField(e.action) + ',' + csvField(e.kind));
      }
      content = lines.join('\n');
      mime = 'text/csv';
      ext = 'csv';
    }

    var today = new Date().toISOString().slice(0, 10);
    var blob = new Blob([content], { type: mime });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'notify-history-' + today + '.' + ext;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function csvField(val) {
    var s = String(val);
    if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  document.getElementById('export-csv').addEventListener('click', function() { exportHistory('csv'); });
  document.getElementById('export-json').addEventListener('click', function() { exportHistory('json'); });

  // ---- Summary ----
  async function loadSummary() {
    try {
      const res = await fetch('/api/summary?' + historyQueryParam());
      const data = await res.json();
      renderSummary(data);
      renderChart(data);
    } catch(e) {
      console.error('Failed to load summary:', e);
    }
  }

  function renderSummary(groups) {
    const el = document.getElementById('summary-content');
    if (!groups || groups.length === 0) {
      el.innerHTML = '<div class="empty-state" style="min-height:60px">No summary data.</div>';
      return;
    }

    let html = '<table><thead><tr><th>Date</th><th>Profile</th><th>Action</th><th>Runs</th><th>Skipped</th></tr></thead><tbody>';
    for (const g of groups) {
      for (const s of g.summaries) {
        html += '<tr>' +
          '<td>' + esc(g.date) + '</td>' +
          '<td>' + profileLink(s.profile) + '</td>' +
          '<td>' + esc(s.action) + '</td>' +
          '<td><span class="badge badge-exec">' + s.executions + '</span></td>' +
          '<td>' + (s.skipped > 0 ? '<span class="badge badge-skip">' + s.skipped + '</span>' : '-') + '</td>' +
          '</tr>';
      }
    }
    html += '</tbody></table>';
    el.innerHTML = html;
  }

  // ---- Activity chart ----
  function renderChart(groups) {
    const section = document.getElementById('chart-section');
    const el = document.getElementById('chart-content');
    const tooltip = document.getElementById('chart-tooltip');

    // Hide for hour-based ranges or empty data
    const val = historyDays.value;
    if (val.endsWith('h') || !groups || groups.length === 0) {
      section.style.display = 'none';
      return;
    }
    section.style.display = '';

    // Aggregate per day: total exec and skipped
    const days = [];
    for (const g of groups) {
      let exec = 0, skip = 0;
      for (const s of g.summaries) {
        exec += s.executions;
        skip += s.skipped;
      }
      days.push({ date: g.date, exec: exec, skip: skip, total: exec + skip });
    }

    // Chart dimensions — use fixed viewBox so it renders correctly even when panel is hidden
    const margin = { top: 8, right: 12, bottom: 32, left: 40 };
    const fullW = 900;
    const fullH = 160;
    const chartW = fullW - margin.left - margin.right;
    const chartH = fullH - margin.top - margin.bottom;

    const maxTotal = Math.max(...days.map(d => d.total), 1);

    // Y-axis grid lines (3-4 lines)
    const gridLines = [];
    const step = niceStep(maxTotal);
    for (let v = step; v <= maxTotal; v += step) gridLines.push(v);
    if (gridLines.length === 0) gridLines.push(maxTotal);
    const yMax = gridLines[gridLines.length - 1] || maxTotal;

    const barGap = Math.max(Math.floor(chartW / days.length * 0.15), 2);
    const barW = Math.max(Math.floor((chartW - barGap * days.length) / days.length), 4);
    const totalBarSpace = (barW + barGap) * days.length;
    const offsetX = margin.left + Math.floor((chartW - totalBarSpace) / 2);

    function yPos(v) { return margin.top + chartH - (v / yMax) * chartH; }

    // Read theme-aware colors from CSS variables
    var cs = getComputedStyle(document.documentElement);
    var cBorder = cs.getPropertyValue('--border').trim();
    var cFgDim = cs.getPropertyValue('--fg-dim').trim();
    var cGreen = cs.getPropertyValue('--green').trim();
    var cYellow = cs.getPropertyValue('--yellow').trim();

    let svg = '<svg width="100%" viewBox="0 0 ' + fullW + ' ' + fullH + '" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">';

    // Grid lines
    for (const v of gridLines) {
      const y = yPos(v);
      svg += '<line x1="' + margin.left + '" y1="' + y + '" x2="' + (fullW - margin.right) + '" y2="' + y + '" stroke="' + cBorder + '" stroke-dasharray="3,3"/>';
      svg += '<text x="' + (margin.left - 6) + '" y="' + (y + 4) + '" fill="' + cFgDim + '" font-size="10" text-anchor="end" font-family="inherit">' + v + '</text>';
    }

    // Baseline
    svg += '<line x1="' + margin.left + '" y1="' + yPos(0) + '" x2="' + (fullW - margin.right) + '" y2="' + yPos(0) + '" stroke="' + cBorder + '"/>';

    // Bars
    for (let i = 0; i < days.length; i++) {
      const d = days[i];
      const x = offsetX + i * (barW + barGap);
      const execH = (d.exec / yMax) * chartH;
      const skipH = (d.skip / yMax) * chartH;

      // Exec bar (green, bottom)
      if (d.exec > 0) {
        svg += '<rect class="chart-bar" data-idx="' + i + '" x="' + x + '" y="' + (yPos(0) - execH) + '" width="' + barW + '" height="' + execH + '" fill="' + cGreen + '" rx="1"/>';
      }
      // Skip bar (yellow, stacked on top)
      if (d.skip > 0) {
        svg += '<rect class="chart-bar" data-idx="' + i + '" x="' + x + '" y="' + (yPos(0) - execH - skipH) + '" width="' + barW + '" height="' + skipH + '" fill="' + cYellow + '" rx="1"/>';
      }
      // Invisible hover target for the full bar area
      svg += '<rect class="chart-bar" data-idx="' + i + '" x="' + x + '" y="' + margin.top + '" width="' + barW + '" height="' + chartH + '" fill="transparent"/>';

      // X-axis labels (show every Nth to avoid crowding)
      var labelEvery = days.length <= 14 ? 1 : days.length <= 30 ? 2 : 3;
      if (i % labelEvery === 0 || i === days.length - 1) {
        var label = shortDate(d.date);
        svg += '<text x="' + (x + barW / 2) + '" y="' + (fullH - 4) + '" fill="' + cFgDim + '" font-size="9" text-anchor="middle" font-family="inherit">' + label + '</text>';
      }
    }

    svg += '</svg>';

    // Keep tooltip element, replace SVG
    var existingSvg = el.querySelector('svg');
    if (existingSvg) existingSvg.remove();
    el.insertAdjacentHTML('afterbegin', svg);

    // Tooltip handlers
    el.querySelectorAll('.chart-bar').forEach(function(bar) {
      bar.addEventListener('mouseenter', function(e) {
        var idx = parseInt(bar.getAttribute('data-idx'));
        var d = days[idx];
        tooltip.innerHTML = '<strong>' + esc(d.date) + '</strong><br>' +
          '<span style="color:var(--green)">Runs: ' + d.exec + '</span>' +
          (d.skip > 0 ? '<br><span style="color:var(--yellow)">Skipped: ' + d.skip + '</span>' : '');
        tooltip.style.display = 'block';
      });
      bar.addEventListener('mousemove', function(e) {
        var rect = el.getBoundingClientRect();
        var tx = e.clientX - rect.left + 12;
        var ty = e.clientY - rect.top - 10;
        // Keep tooltip in bounds
        if (tx + 140 > rect.width) tx = e.clientX - rect.left - 140;
        tooltip.style.left = tx + 'px';
        tooltip.style.top = ty + 'px';
      });
      bar.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
    });
  }

  function shortDate(dateStr) {
    var parts = dateStr.split('-');
    var d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return days[d.getDay()] + ' ' + d.getDate();
  }

  function niceStep(max) {
    if (max <= 5) return 1;
    if (max <= 10) return 2;
    if (max <= 25) return 5;
    if (max <= 50) return 10;
    if (max <= 100) return 20;
    if (max <= 250) return 50;
    if (max <= 500) return 100;
    return Math.ceil(max / 5 / 100) * 100;
  }

  // ---- Toast notifications ----
  const toastContainer = document.getElementById('toast-container');

  function showToast(entry) {
    const el = document.createElement('div');
    const kindCls = entry.kind === 'cooldown' ? ' toast-cooldown' : entry.kind === 'silent' ? ' toast-silent' : '';
    el.className = 'toast' + kindCls;
    el.innerHTML =
      '<span class="toast-profile">' + esc(maskProfile(entry.profile)) + '</span> ' +
      '<span class="toast-action">' + esc(entry.action) + '</span>' +
      '<div class="toast-kind ' + kindClass(entry.kind) + '">' + esc(entry.kind) + '</div>';
    toastContainer.appendChild(el);
    setTimeout(() => el.remove(), 4300);
  }

  // ---- SSE ----
  const sseDot = document.getElementById('sse-dot');
  const sseStatus = document.getElementById('sse-status');

  function connectSSE() {
    const source = new EventSource('/api/events');

    source.onopen = () => {
      sseDot.style.background = 'var(--green)';
      sseStatus.textContent = 'live';
    };

    source.onmessage = (event) => {
      try {
        const entries = JSON.parse(event.data);
        for (const e of entries) {
          // Skip bookkeeping entries (e.g. cooldown=recorded) — only show
          // execution, cooldown-skipped, and silent-skipped events.
          if (e.kind === 'other') continue;
          appendHistoryRow(e, true);
          showToast(e);
        }
      } catch(e) {
        console.error('SSE parse error:', e);
      }
    };

    source.onerror = () => {
      sseDot.style.background = 'var(--red)';
      sseStatus.textContent = 'disconnected';
      source.close();
      // Reconnect after 5s
      setTimeout(connectSSE, 5000);
    };
  }

  // ---- Config ----
  let configData = null;

  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      configData = await res.json();
      renderConfigJson();
      await loadLogProfiles();
      populateTestDropdowns();
      loadCredentials();
    } catch(e) {
      document.getElementById('config-content').textContent = 'Failed to load config: ' + e;
    }
  }

  function renderConfigJson() {
    if (!configData) return;
    var text = JSON.stringify(configData, null, 2);
    if (screenshotMode) {
      if (configData.profiles) {
        for (var p of Object.keys(configData.profiles)) maskProfile(p);
      }
      for (var real in screenshotMap) {
        text = text.replaceAll(real, screenshotMap[real]);
      }
    }
    document.getElementById('config-content').textContent = text;
  }

  // ---- Log stats ----
  let cachedStats = null;

  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      cachedStats = await res.json();
    } catch(e) {
      console.error('Failed to load stats:', e);
    }
  }

  function fmtFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1).replace(/\.0$/, '') + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1).replace(/\.0$/, '') + ' MB';
  }

  function fmtShortDate(isoStr) {
    if (!isoStr) return '';
    const d = new Date(isoStr);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }

  // ---- Credentials ----
  let cachedCredentials = null;

  async function loadCredentials() {
    try {
      const res = await fetch('/api/credentials');
      const data = await res.json();
      cachedCredentials = data;
      renderCredentials(data);
    } catch(e) {
      console.error('Failed to load credentials:', e);
    }
  }

  function renderCredentials(profiles) {
    const panel = document.getElementById('cred-panel');
    const content = document.getElementById('cred-content');
    if (!profiles || profiles.length === 0) {
      panel.style.display = 'none';
      return;
    }
    panel.style.display = '';
    let html = '';
    for (const p of profiles) {
      html += '<div class="cred-profile">';
      html += '<span class="cred-profile-name">' + profileLink(p.profile) + '</span>';
      for (const c of p.credentials) {
        const cls = c.status === 'ok' ? 'cred-ok' : 'cred-missing';
        html += '<span class="cred-badge ' + cls + '">' + esc(c.type) + ': ' + esc(c.status) + '</span>';
      }
      html += '</div>';
    }
    content.innerHTML = html;
  }

  // ---- Test ----
  let logProfiles = {}; // profile -> Set of action names from recent log

  async function loadLogProfiles() {
    try {
      const res = await fetch('/api/summary?days=2');
      const data = await res.json();
      logProfiles = {};
      if (data) {
        for (const g of data) {
          for (const s of g.summaries) {
            if (!logProfiles[s.profile]) logProfiles[s.profile] = new Set();
            logProfiles[s.profile].add(s.action);
          }
        }
      }
    } catch(e) {
      console.error('Failed to load log profiles:', e);
    }
  }

  function populateTestDropdowns() {
    const profileSel = document.getElementById('test-profile');
    const actionSel = document.getElementById('test-action');
    profileSel.innerHTML = '';

    // Merge config profiles with log profiles (last 48h).
    const configProfiles = (configData && configData.profiles) ? Object.keys(configData.profiles) : [];
    const allProfiles = new Set(configProfiles);
    for (const p of Object.keys(logProfiles)) allProfiles.add(p);

    const configSet = new Set(configProfiles);
    const inConfig = [...allProfiles].filter(p => configSet.has(p)).sort();
    const logOnly = [...allProfiles].filter(p => !configSet.has(p)).sort();
    for (const p of inConfig) {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = maskProfile(p) + ' (config)';
      profileSel.appendChild(opt);
    }
    for (const p of logOnly) {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = maskProfile(p) + ' (log extracted)';
      profileSel.appendChild(opt);
    }

    profileSel.addEventListener('change', () => updateActions());
    updateActions();

    function updateActions() {
      const pName = profileSel.value;
      actionSel.innerHTML = '<option value="">(all actions)</option>';

      const actions = new Set();

      // Actions from config.
      if (configData && configData.profiles && configData.profiles[pName]) {
        const p = configData.profiles[pName];
        const reserved = new Set(['extends', 'aliases', 'credentials', 'match']);
        for (const k of Object.keys(p)) {
          if (!reserved.has(k)) actions.add(k);
        }
      }

      // Actions from log.
      if (logProfiles[pName]) {
        for (const a of logProfiles[pName]) actions.add(a);
      }

      for (const a of [...actions].sort()) {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        actionSel.appendChild(opt);
      }
    }
  }

  document.getElementById('test-btn').addEventListener('click', async () => {
    const profile = document.getElementById('test-profile').value;
    const action = document.getElementById('test-action').value;
    const resultsEl = document.getElementById('test-results');

    if (!profile) {
      resultsEl.innerHTML = '<div class="empty-state">Select a profile first.</div>';
      return;
    }

    try {
      const res = await fetch('/api/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profile, action })
      });

      if (!res.ok) {
        const text = await res.text();
        resultsEl.innerHTML = '<div class="empty-state" style="color:var(--red)">' + esc(text) + '</div>';
        return;
      }

      const data = await res.json();
      if (!data || data.length === 0) {
        resultsEl.innerHTML = '<div class="empty-state">No actions found.</div>';
        return;
      }

      let html = '';
      for (const ar of data) {
        html += '<div style="margin-bottom:16px">';
        let actionLabel = '<div class="action-name">' + esc(ar.action) +
                ' <span style="color:var(--fg-dim);font-weight:400;font-size:12px">(' +
                ar.total_run + '/' + (ar.total_run + ar.total_skip) + ' steps would run)';
        if (ar.resolved) actionLabel += ' via ' + esc(ar.resolved);
        actionLabel += '</span></div>';
        html += actionLabel;
        for (const s of ar.steps) {
          const mc = s.would_run ? 'run' : 'skip';
          const ml = s.would_run ? 'RUN' : 'SKIP';
          html += '<div class="step">' +
            '<span class="marker ' + mc + '">' + ml + '</span>' +
            '<span class="idx">[' + s.index + ']</span>' +
            '<span class="type">' + esc(s.type) + '</span>' +
            '<span class="detail">' + esc(s.detail) + '</span>' +
            '</div>';
        }
        html += '</div>';
      }
      resultsEl.innerHTML = html;
    } catch(e) {
      resultsEl.innerHTML = '<div class="empty-state" style="color:var(--red)">Request failed: ' + esc(String(e)) + '</div>';
    }
  });

  // ---- Watch tab ----
  let watchBaseline = null;
  let watchDate = null; // null = today, or "YYYY-MM-DD"

  const watchNavDate = document.getElementById('watch-nav-date');
  const watchPrev = document.getElementById('watch-prev');
  const watchNext = document.getElementById('watch-next');
  const watchToday = document.getElementById('watch-today');

  function todayStr() {
    const d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate());
  }

  function shiftDate(dateStr, delta) {
    const d = new Date(dateStr + 'T12:00:00');
    d.setDate(d.getDate() + delta);
    return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate());
  }

  function dayName(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString(undefined, { weekday: 'long' });
  }

  function updateWatchNav() {
    const effective = watchDate || todayStr();
    const isToday = effective === todayStr();
    watchNavDate.textContent = effective + '  (' + dayName(effective) + ')';
    watchNext.disabled = isToday;
    watchToday.style.display = isToday ? 'none' : '';
  }

  watchPrev.addEventListener('click', () => {
    const effective = watchDate || todayStr();
    watchDate = shiftDate(effective, -1);
    watchBaseline = null;
    updateWatchNav();
    loadWatch();
  });

  watchNext.addEventListener('click', () => {
    if (watchDate) {
      const next = shiftDate(watchDate, 1);
      watchDate = next === todayStr() ? null : next;
      watchBaseline = null;
      updateWatchNav();
      loadWatch();
    }
  });

  watchToday.addEventListener('click', () => {
    watchDate = null;
    watchBaseline = null;
    updateWatchNav();
    loadWatch();
  });

  updateWatchNav();

  async function loadWatch() {
    try {
      let url = '/api/watch';
      if (watchDate) url += '?date=' + watchDate;
      const res = await fetch(url);
      const data = await res.json();
      if (data.is_today && !watchBaseline) {
        watchBaseline = buildWatchBaseline(data);
      }
      renderWatch(data);
    } catch(e) {
      console.error('Failed to load watch:', e);
    }
  }

  function buildWatchBaseline(data) {
    const b = {};
    if (data.summary && data.summary.profiles) {
      for (const p of data.summary.profiles) {
        for (const a of p.actions) {
          b[p.name + '/' + a.name] = a.total;
        }
      }
    }
    return b;
  }

  function renderWatch(data) {
    const el = document.getElementById('watch-content');
    if (!data.summary.profiles.length && !data.hourly.hours.length) {
      el.innerHTML = '<div class="empty-state">No activity for ' + esc(data.date) + '.</div>';
      return;
    }

    const showNew = data.is_today;
    let html = '';

    // Summary table
    const hasSkipped = data.summary.grand_skipped > 0;
    const profiles = data.summary.profiles;
    const gt = data.summary.grand_total;

    html += '<div style="border-top:1px solid var(--border);margin-top:4px;padding-top:12px" class="watch-section-title">Summary</div>';
    html += '<div style="display:flex;gap:32px;align-items:flex-start">';
    html += '<div style="overflow-x:auto">';
    html += '<table class="watch-table"><thead><tr>';
    html += '<th style="min-width:180px"></th><th>Total</th><th>%</th>';
    if (hasSkipped) html += '<th>Skipped</th>';
    if (showNew) html += '<th>New</th>';
    html += '</tr></thead><tbody>';

    let totalNew = 0;
    for (const p of profiles) {
      // Profile subtotal row
      let pNew = 0;
      if (showNew) {
        for (const a of p.actions) {
          const key = p.name + '/' + a.name;
          pNew += a.total - (watchBaseline[key] || 0);
        }
        if (pNew < 0) pNew = 0;
        totalNew += pNew;
      }

      html += '<tr class="profile-row">';
      html += '<td class="profile-name">' + profileLink(p.name) + '</td>';
      html += '<td>' + fmtNum(p.total) + '</td>';
      html += '<td>' + (gt > 0 ? p.pct + '%' : '') + '</td>';
      if (hasSkipped) {
        html += '<td class="val-skip">' + (p.skipped > 0 ? fmtNum(p.skipped) : '') + '</td>';
      }
      if (showNew) html += '<td class="val-new">' + (pNew > 0 ? '+' + fmtNum(pNew) : '') + '</td>';
      html += '</tr>';

      // Action rows (indented)
      for (const a of p.actions) {
        const key = p.name + '/' + a.name;
        const aN = showNew ? a.total - (watchBaseline[key] || 0) : 0;
        html += '<tr>';
        html += '<td class="action-name">' + esc(a.name) + '</td>';
        html += '<td>' + fmtNum(a.total) + '</td>';
        html += '<td></td>';
        if (hasSkipped) {
          html += '<td class="val-skip">' + (a.skipped > 0 ? fmtNum(a.skipped) : '') + '</td>';
        }
        if (showNew) html += '<td class="val-new">' + (aN > 0 ? '+' + fmtNum(aN) : '') + '</td>';
        html += '</tr>';
      }
    }

    // Total row
    html += '<tr class="total-row">';
    html += '<td><strong>Total</strong></td>';
    html += '<td><strong>' + fmtNum(gt) + '</strong></td>';
    html += '<td></td>';
    if (hasSkipped) {
      html += '<td class="val-skip">' + (data.summary.grand_skipped > 0 ? fmtNum(data.summary.grand_skipped) : '') + '</td>';
    }
    if (showNew) html += '<td class="val-new">' + (totalNew > 0 ? '+' + fmtNum(totalNew) : '') + '</td>';
    html += '</tr>';

    html += '</tbody></table>';
    html += '</div>'; // end table wrapper
    html += renderDonutChart(profiles, gt);
    html += '</div>'; // end flex wrapper

    // Hourly breakdown table
    if (data.hourly.hours && data.hourly.hours.length > 0) {
      html += '<div style="border-top:1px solid var(--border);margin-top:20px;padding-top:12px" class="watch-section-title">Hourly breakdown</div>';
      html += '<div style="display:flex;gap:32px;align-items:flex-start">';
      html += '<div style="overflow-x:auto">';
      html += '<table class="watch-table"><thead><tr>';
      html += '<th>Hour</th>';
      for (const p of data.hourly.profiles) {
        html += '<th style="color:var(--cyan)">' + esc(maskProfile(p)) + '</th>';
      }
      html += '<th>Total</th><th>%</th>';
      html += '</tr></thead><tbody>';

      for (const hr of data.hourly.hours) {
        html += '<tr>';
        html += '<td style="text-align:left">' + pad2(hr.hour) + ':00</td>';
        for (const c of hr.counts) {
          if (c > 0) {
            html += '<td>' + fmtNum(c) + '</td>';
          } else {
            html += '<td class="val-dash">-</td>';
          }
        }
        if (hr.total > 0) {
          html += '<td>' + fmtNum(hr.total) + '</td>';
          html += '<td>' + hr.pct + '%</td>';
        } else {
          html += '<td class="val-dash">-</td>';
          html += '<td></td>';
        }
        html += '</tr>';
      }

      // Hourly total row
      html += '<tr class="total-row">';
      html += '<td style="text-align:left"><strong>Total</strong></td>';
      for (const pt of data.hourly.profile_totals) {
        html += '<td><strong>' + fmtNum(pt) + '</strong></td>';
      }
      html += '<td><strong>' + fmtNum(data.hourly.grand_total) + '</strong></td>';
      html += '<td></td>';
      html += '</tr>';

      html += '</tbody></table>';
      html += '</div>'; // end table wrapper
      html += '<div style="flex-shrink:0">' + renderHourlyBarChart(data.hourly) + renderActivityTimeline(data.hourly) + '</div>';
      html += '</div>'; // end flex wrapper
    }

    // Approximate time spent (after hourly)
    if (data.time_spent && data.time_spent.total > 0) {
      html += '<div style="border-top:1px solid var(--border);margin-top:20px;padding-top:12px" class="watch-section-title">Approx. time spent</div>';
      html += '<div style="font-size:11px;color:var(--fg-dim);margin-top:-4px;margin-bottom:8px">';
      html += 'Rough estimate based on gaps between log entries (&le; 5 min counted as active).';
      html += '</div>';
      html += '<div style="display:flex;gap:32px;align-items:flex-start">';
      html += '<div style="overflow-x:auto">';
      html += '<table class="watch-table"><thead><tr>';
      html += '<th style="min-width:180px"></th><th>Time</th><th>%</th>';
      html += '</tr></thead><tbody>';
      for (const tp of data.time_spent.profiles) {
        if (tp.seconds === 0) continue;
        const pct = data.time_spent.total > 0 ? Math.round(tp.seconds * 100 / data.time_spent.total) : 0;
        html += '<tr class="profile-row">';
        html += '<td class="profile-name">' + profileLink(tp.name) + '</td>';
        html += '<td>' + fmtDuration(tp.seconds) + '</td>';
        html += '<td>' + pct + '%</td>';
        html += '</tr>';
      }
      html += '<tr class="total-row">';
      html += '<td><strong>Total</strong></td>';
      html += '<td><strong>' + fmtDuration(data.time_spent.total) + '</strong></td>';
      html += '<td></td>';
      html += '</tr>';
      html += '</tbody></table>';
      html += '</div>'; // end table wrapper
      html += renderTimeDonutChart(data.time_spent);
      html += '</div>'; // end flex wrapper
    }

    // Log file stats
    if (cachedStats && cachedStats.entries > 0) {
      html += '<div style="border-top:1px solid var(--border);margin-top:20px;padding-top:10px;color:var(--fg-dim);font-size:12px">';
      html += 'Log: ' + fmtNum(cachedStats.entries) + ' entries';
      html += ' &middot; ' + fmtFileSize(cachedStats.file_size);
      const oldest = fmtShortDate(cachedStats.oldest_entry);
      const newest = fmtShortDate(cachedStats.newest_entry);
      if (oldest && newest) {
        html += ' &middot; ' + (oldest === newest ? oldest : oldest + ' – ' + newest);
      }
      html += '</div>';
    }

    el.innerHTML = html;
    wireDonutTooltips(el);
  }

  function fmtNum(n) {
    if (n < 1000) return String(n);
    return n.toLocaleString('de-DE');
  }

  function pad2(n) {
    return n < 10 ? '0' + n : String(n);
  }

  function fmtDuration(secs) {
    const h = Math.floor(secs / 3600);
    const m = Math.floor((secs % 3600) / 60);
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  // ---- Hourly bar chart ----
  function renderHourlyBarChart(hourly) {
    var hours = hourly.hours;
    var profiles = hourly.profiles || [];
    if (!hours || hours.length === 0) return '';
    var maxTotal = 0;
    for (var i = 0; i < hours.length; i++) {
      if (hours[i].total > maxTotal) maxTotal = hours[i].total;
    }
    if (maxTotal === 0) return '';

    var barW = 14, gap = 2, chartH = 108, labelH = 14;
    var totalW = hours.length * (barW + gap) - gap;
    var svgW = totalW + 2;
    var svgH = chartH + labelH;

    var cs = getComputedStyle(document.documentElement);
    var fg = cs.getPropertyValue('--fg').trim();
    var fgDim = cs.getPropertyValue('--fg-dim').trim();

    var svg = '<svg width="' + svgW + '" height="' + svgH + '" viewBox="0 0 ' + svgW + ' ' + svgH + '">';

    for (var i = 0; i < hours.length; i++) {
      var hr = hours[i];
      var x = 1 + i * (barW + gap);
      var barH = maxTotal > 0 ? Math.max(Math.round((hr.total / maxTotal) * (chartH - 2)), 0) : 0;
      var y = chartH - barH;

      if (barH > 0) {
        var detail = '';
        for (var j = 0; j < profiles.length; j++) {
          if (hr.counts[j] > 0) {
            detail += esc(maskProfile(profiles[j])).replace(/"/g, '&quot;') +
              ': ' + hr.counts[j] + '&lt;br&gt;';
          }
        }
        svg += '<rect class="donut-segment" x="' + x + '" y="' + y + '" width="' + barW + '" height="' + barH +
          '" fill="transparent" stroke="' + fg + '" stroke-width="1" rx="1"' +
          ' data-name="' + pad2(hr.hour) + ':00" data-total="' + hr.total + '" data-pct="' + hr.pct +
          '" data-detail="' + detail + '"' +
          ' style="cursor:crosshair;transition:opacity 0.15s"/>';
      }

      // Show every 3rd hour label to keep it compact
      if (i % 3 === 0) {
        svg += '<text x="' + (x + barW / 2) + '" y="' + (chartH + labelH - 2) +
          '" text-anchor="middle" font-size="7" font-family="inherit" fill="' + fgDim + '">' +
          pad2(hr.hour) + '</text>';
      }
    }

    svg += '</svg>';
    return '<div style="flex-shrink:0;text-align:center;padding-top:20px">' +
      '<div class="watch-section-title" style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">Activity by hour</div>' +
      '<div style="position:relative;display:inline-block">' + svg +
      '<div class="chart-tooltip donut-tooltip"></div></div></div>';
  }

  // ---- Activity timeline ----
  function renderActivityTimeline(hourly) {
    var hours = hourly.hours;
    var profiles = hourly.profiles || [];
    if (!hours || hours.length === 0 || profiles.length === 0) return '';

    var cs = getComputedStyle(document.documentElement);
    var fg = cs.getPropertyValue('--fg').trim();
    var fgDim = cs.getPropertyValue('--fg-dim').trim();

    var cellW = 14, gap = 2, rowH = 20, rowGap = 3, labelW = 60, labelH = 14;
    var chartW = hours.length * (cellW + gap) - gap;
    var svgW = labelW + chartW + 2;
    var svgH = profiles.length * (rowH + rowGap) - rowGap + labelH + 4;

    var svg = '<svg width="' + svgW + '" height="' + svgH + '" viewBox="0 0 ' + svgW + ' ' + svgH + '">';

    // Find max per-cell count for opacity scaling.
    var maxCount = 0;
    for (var i = 0; i < hours.length; i++) {
      for (var j = 0; j < profiles.length; j++) {
        if (hours[i].counts[j] > maxCount) maxCount = hours[i].counts[j];
      }
    }

    for (var p = 0; p < profiles.length; p++) {
      var y = p * (rowH + rowGap);

      // Profile label
      svg += '<text x="' + (labelW - 4) + '" y="' + (y + rowH - 2) +
        '" text-anchor="end" font-size="8" font-family="inherit" fill="' + fgDim + '">' +
        esc(maskProfile(profiles[p])).replace(/"/g, '&quot;') + '</text>';

      for (var i = 0; i < hours.length; i++) {
        var x = labelW + i * (cellW + gap);
        var count = hours[i].counts[p];

        var pName = esc(maskProfile(profiles[p])).replace(/"/g, '&quot;');
        var hrTotal = hours[i].total;
        var hrPct = hrTotal > 0 ? Math.round(count * 100 / hrTotal) : 0;
        if (count > 0) {
          svg += '<rect class="donut-segment" x="' + x + '" y="' + y + '" width="' + cellW + '" height="' + rowH +
            '" fill="' + fg + '" stroke="' + fg + '" stroke-width="1" rx="1"' +
            ' opacity="' + (0.25 + 0.75 * (count / maxCount)).toFixed(2) + '"' +
            ' data-name="' + pName + ' · ' + pad2(hours[i].hour) + ':00"' +
            ' data-total="' + count + '" data-pct="' + hrPct + '"' +
            ' style="cursor:crosshair;transition:opacity 0.15s"/>';
        } else {
          svg += '<rect x="' + x + '" y="' + y + '" width="' + cellW + '" height="' + rowH +
            '" fill="none" stroke="' + fgDim + '" stroke-width="0.5" rx="1" opacity="0.3"/>';
        }
      }
    }

    // Hour labels
    var labelY = profiles.length * (rowH + rowGap) + labelH;
    for (var i = 0; i < hours.length; i++) {
      if (i % 3 === 0) {
        var x = labelW + i * (cellW + gap) + cellW / 2;
        svg += '<text x="' + x + '" y="' + labelY +
          '" text-anchor="middle" font-size="7" font-family="inherit" fill="' + fgDim + '">' +
          pad2(hours[i].hour) + '</text>';
      }
    }

    svg += '</svg>';
    return '<div style="text-align:center;margin-top:12px">' +
      '<div class="watch-section-title" style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">Timeline</div>' +
      '<div style="position:relative;display:inline-block">' + svg +
      '<div class="chart-tooltip donut-tooltip"></div></div></div>';
  }

  // ---- Donut chart ----
  function polarXY(cx, cy, r, deg) {
    var rad = (deg - 90) * Math.PI / 180;
    return [cx + r * Math.cos(rad), cy + r * Math.sin(rad)];
  }

  function donutArc(cx, cy, oR, iR, sDeg, eDeg) {
    var os = polarXY(cx, cy, oR, sDeg), oe = polarXY(cx, cy, oR, eDeg);
    var is_ = polarXY(cx, cy, iR, eDeg), ie = polarXY(cx, cy, iR, sDeg);
    var lg = (eDeg - sDeg) > 180 ? 1 : 0;
    return 'M ' + os[0] + ' ' + os[1] +
      ' A ' + oR + ' ' + oR + ' 0 ' + lg + ' 1 ' + oe[0] + ' ' + oe[1] +
      ' L ' + is_[0] + ' ' + is_[1] +
      ' A ' + iR + ' ' + iR + ' 0 ' + lg + ' 0 ' + ie[0] + ' ' + ie[1] + ' Z';
  }

  function renderDonutChart(profiles, grandTotal) {
    if (!profiles || profiles.length === 0 || grandTotal === 0) return '';
    var cs = getComputedStyle(document.documentElement);
    var fg = cs.getPropertyValue('--fg').trim();
    var size = 108, cx = 54, cy = 54, oR = 48, iR = 30;
    var svg = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
    var angle = 0;
    for (var i = 0; i < profiles.length; i++) {
      var p = profiles[i];
      if (p.total === 0) continue;
      var sweep = (p.total / grandTotal) * 360;
      if (sweep >= 360) sweep = 359.99;
      var name = esc(maskProfile(p.name)).replace(/"/g, '&quot;');
      svg += '<path class="donut-segment" d="' + donutArc(cx, cy, oR, iR, angle, angle + sweep) +
        '" fill="transparent" stroke="' + fg + '" stroke-width="1.5" data-name="' + name +
        '" data-total="' + p.total + '" data-pct="' + p.pct +
        '" style="cursor:crosshair;transition:opacity 0.15s"/>';
      angle += sweep;
    }
    // Center label
    svg += '<text x="' + cx + '" y="' + (cy + 1) + '" text-anchor="middle" fill="' +
      cs.getPropertyValue('--fg').trim() + '" font-size="14" font-weight="700" font-family="inherit">' + grandTotal + '</text>';
    svg += '<text x="' + cx + '" y="' + (cy + 13) + '" text-anchor="middle" fill="' +
      cs.getPropertyValue('--fg-dim').trim() + '" font-size="8" font-family="inherit">total</text>';
    svg += '</svg>';
    return '<div style="flex-shrink:0;text-align:center;padding-top:5px">' +
      '<div class="watch-section-title" style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">Notifications per project</div>' +
      '<div style="position:relative;display:inline-block">' + svg +
      '<div class="chart-tooltip donut-tooltip"></div></div></div>';
  }

  function renderTimeDonutChart(timeSpent) {
    if (!timeSpent || !timeSpent.profiles || timeSpent.total === 0) return '';
    var profs = timeSpent.profiles.filter(function(p) { return p.seconds > 0; });
    if (profs.length === 0) return '';
    var cs = getComputedStyle(document.documentElement);
    var fg = cs.getPropertyValue('--fg').trim();
    var size = 108, cx = 54, cy = 54, oR = 48, iR = 30;
    var svg = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
    var angle = 0;
    for (var i = 0; i < profs.length; i++) {
      var p = profs[i];
      var sweep = (p.seconds / timeSpent.total) * 360;
      if (sweep >= 360) sweep = 359.99;
      var pct = Math.round(p.seconds * 100 / timeSpent.total);
      var name = esc(maskProfile(p.name)).replace(/"/g, '&quot;');
      svg += '<path class="donut-segment" d="' + donutArc(cx, cy, oR, iR, angle, angle + sweep) +
        '" fill="transparent" stroke="' + fg + '" stroke-width="1.5" data-name="' + name +
        '" data-total="' + fmtDuration(p.seconds) + '" data-pct="' + pct +
        '" style="cursor:crosshair;transition:opacity 0.15s"/>';
      angle += sweep;
    }
    svg += '<text x="' + cx + '" y="' + (cy + 1) + '" text-anchor="middle" fill="' +
      cs.getPropertyValue('--fg').trim() + '" font-size="12" font-weight="700" font-family="inherit">' + fmtDuration(timeSpent.total) + '</text>';
    svg += '<text x="' + cx + '" y="' + (cy + 13) + '" text-anchor="middle" fill="' +
      cs.getPropertyValue('--fg-dim').trim() + '" font-size="8" font-family="inherit">total</text>';
    svg += '</svg>';
    return '<div style="flex-shrink:0;text-align:center;padding-top:5px">' +
      '<div class="watch-section-title" style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">Time per project</div>' +
      '<div style="position:relative;display:inline-block">' + svg +
      '<div class="chart-tooltip donut-tooltip"></div></div></div>';
  }

  function wireDonutTooltips(container) {
    container.querySelectorAll('.donut-tooltip').forEach(function(tip) {
      var wrap = tip.parentElement;
      wrap.querySelectorAll('.donut-segment').forEach(function(seg) {
        seg.addEventListener('mouseenter', function() {
          var detail = seg.getAttribute('data-detail');
          tip.innerHTML = '<strong>' + seg.getAttribute('data-name') + '</strong><br>' +
            seg.getAttribute('data-total') + ' (' + seg.getAttribute('data-pct') + '%)' +
            (detail ? '<br>' + detail : '');
          tip.style.display = 'block';
          seg.style.opacity = '0.8';
        });
        seg.addEventListener('mousemove', function(e) {
          var rect = wrap.getBoundingClientRect();
          var tx = e.clientX - rect.left + 12;
          var ty = e.clientY - rect.top - 10;
          if (tx + 120 > rect.width) tx = e.clientX - rect.left - 120;
          tip.style.left = tx + 'px';
          tip.style.top = ty + 'px';
        });
        seg.addEventListener('mouseleave', function() {
          tip.style.display = 'none';
          seg.style.opacity = '1';
        });
      });
    });
  }

  // ---- Profile detail modal ----
  function profileLink(name) {
    return '<span class="profile-link" onclick="window._openProfileModal(\'' + esc(name).replace(/'/g, "\\'") + '\')">' + esc(maskProfile(name)) + '</span>';
  }

  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalEl = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');

  function openProfileModal(profileName) {
    modalTitle.textContent = maskProfile(profileName);
    modalBody.innerHTML = '<div class="modal-loading">Loading...</div>';
    modalBackdrop.style.display = '';

    // Fetch dry-run data for all actions
    fetch('/api/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profile: profileName, action: '' })
    })
    .then(function(res) {
      if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
      return res.json();
    })
    .then(function(data) {
      let html = '';

      // Actions section
      html += '<div class="modal-section-title">Actions</div>';
      if (!data || data.length === 0) {
        html += '<div style="color:var(--fg-dim);font-size:13px">No actions found for this profile.</div>';
      } else {
        for (const ar of data) {
          html += '<div style="margin-bottom:14px">';
          html += '<div class="action-name">' + esc(ar.action) +
            ' <span style="color:var(--fg-dim);font-weight:400;font-size:12px">(' +
            ar.total_run + '/' + (ar.total_run + ar.total_skip) + ' steps would run)';
          if (ar.resolved) html += ' via ' + esc(ar.resolved);
          html += '</span></div>';
          for (const s of ar.steps) {
            const mc = s.would_run ? 'run' : 'skip';
            const ml = s.would_run ? 'RUN' : 'SKIP';
            html += '<div class="step">' +
              '<span class="marker ' + mc + '">' + ml + '</span>' +
              '<span class="idx">[' + s.index + ']</span>' +
              '<span class="type">' + esc(s.type) + '</span>' +
              '<span class="detail">' + esc(s.detail) + '</span>' +
              '</div>';
          }
          html += '</div>';
        }
      }

      // Credentials section (from cache)
      if (cachedCredentials) {
        const match = cachedCredentials.find(function(p) { return p.profile === profileName; });
        if (match) {
          html += '<div class="modal-section-title">Credentials</div>';
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
          for (const c of match.credentials) {
            const cls = c.status === 'ok' ? 'cred-ok' : 'cred-missing';
            html += '<span class="cred-badge ' + cls + '">' + esc(c.type) + ': ' + esc(c.status) + '</span>';
          }
          html += '</div>';
        }
      }

      modalBody.innerHTML = html;
    })
    .catch(function(err) {
      modalBody.innerHTML = '<div style="color:var(--red);font-size:13px">' + esc(String(err)) + '</div>';
    });
  }

  window._openProfileModal = openProfileModal;

  function closeModal() {
    modalBackdrop.style.display = 'none';
  }

  document.getElementById('modal-close').addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', function(e) {
    if (e.target === modalBackdrop) closeModal();
  });

  // ---- Voice tab ----
  var voiceDays = document.getElementById('voice-days');
  var voiceContent = document.getElementById('voice-content');

  async function loadVoice() {
    var days = voiceDays.value;
    try {
      var resp = await fetch('/api/voice?days=' + days);
      var data = await resp.json();
      renderVoice(data);
    } catch(e) {
      voiceContent.innerHTML = '<div class="empty-state">Failed to load voice data.</div>';
    }
  }

  function renderVoice(data) {
    if (!data.lines || data.lines.length === 0) {
      voiceContent.innerHTML = '<div class="empty-state">No voice lines found.</div>';
      return;
    }
    var html = '<div style="margin-bottom:12px;color:var(--fg-dim);font-size:13px">' +
      fmtNum(data.total) + ' total utterances across ' + fmtNum(data.lines.length) + ' unique texts</div>';
    html += '<table><thead><tr><th>#</th><th>Count</th><th>%</th><th>Text</th></tr></thead><tbody>';
    for (var i = 0; i < data.lines.length; i++) {
      var l = data.lines[i];
      html += '<tr><td>' + l.rank + '</td><td>' + fmtNum(l.count) +
        '</td><td>' + l.pct + '%</td><td style="color:var(--fg-dim)">&ldquo;</span>' +
        esc(l.text) + '<span style="color:var(--fg-dim)">&rdquo;</td></tr>';
    }
    html += '</tbody></table>';
    voiceContent.innerHTML = html;
  }

  voiceDays.addEventListener('change', loadVoice);

  // ---- Polling: refresh every 2s ----
  setInterval(() => {
    loadHistory();
    loadSummary();
    // Only auto-refresh watch when viewing today (live data).
    if (!watchDate) loadWatch();
    loadVoice();
  }, 2000);

  // ---- Screenshot toggle ----
  function toggleScreenshot() {
    screenshotMode = !screenshotMode;
    localStorage.setItem('notify-screenshot', screenshotMode ? 'on' : '');
    localStorage.setItem('notify-screenshot-map', JSON.stringify(screenshotMap));
    updateScreenshotBadge();
    renderHistory(allHistoryEntries);
    loadSummary();
    loadWatch();
    renderConfigJson();
    if (cachedCredentials) renderCredentials(cachedCredentials);
    populateTestDropdowns();
  }

  // ---- Keyboard shortcuts ----
  const tabNames = ['watch', 'history', 'config', 'test', 'voice'];

  function activeTab() {
    const active = document.querySelector('.tab.active');
    return active ? active.dataset.panel : '';
  }

  document.addEventListener('keydown', function(e) {
    // Escape closes modal first
    if (e.key === 'Escape' && modalBackdrop.style.display !== 'none') {
      closeModal();
      e.preventDefault();
      return;
    }

    const tag = e.target.tagName.toLowerCase();
    if (tag === 'input' || tag === 'select' || tag === 'textarea') return;

    // 1-5: switch tabs
    if (e.key >= '1' && e.key <= '5') {
      switchTab(tabNames[parseInt(e.key) - 1]);
      e.preventDefault();
      return;
    }

    // S: toggle screenshot mode
    if (e.key === 's' || e.key === 'S') {
      toggleScreenshot();
      e.preventDefault();
      return;
    }

    // Arrow keys: watch tab day navigation
    if (activeTab() === 'watch') {
      if (e.key === 'ArrowLeft') {
        watchPrev.click();
        e.preventDefault();
        return;
      }
      if (e.key === 'ArrowRight' && !watchNext.disabled) {
        watchNext.click();
        e.preventDefault();
        return;
      }
      if (e.key === 't') {
        watchToday.click();
        e.preventDefault();
        return;
      }
    }
  });

  // ---- Init ----
  loadHistory();
  loadSummary();
  loadStats().then(loadWatch);
  loadConfig();
  loadVoice();
  connectSSE();
})();
</script>
</body>
</html>
